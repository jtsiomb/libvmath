csrc = $(wildcard src/*.c)
ccsrc = $(wildcard src/*.cc)
obj = $(csrc:.c=.o) $(ccsrc:.cc=.o)
depfiles = $(obj:.o=.d)

lib_a = libvmath.a
lib_so = libvmath.$(so)

CC = gcc
CXX = g++
CFLAGS = -std=c89 -pedantic -Wall -Wno-strict-aliasing $(opt) $(dbg) -fPIC -Isrc
CXXFLAGS = -ansi -pedantic -Wall -Wno-strict-aliasing $(opt) $(dbg) -fPIC -Isrc
LDFLAGS =

.PHONY: all
all: $(lib_a) $(lib_so)

$(lib_a): $(obj)
	$(AR) rcs $@ $^

$(lib_so): $(obj)
	$(CXX) $(CFLAGS) $(shared) -o $@ $^ $(LDFLAGS)

.PHONY: install
install: $(lib_a) $(lib_so)
	$(INSTALL) -d $(PREFIX)/lib
	$(INSTALL) -m 644 $(lib_a) $(lib_so) $(PREFIX)/lib
	$(INSTALL) -d $(PREFIX)/include/vmath
	cd src; $(INSTALL) -m 644 *.h *.inl $(PREFIX)/include/vmath
	$(INSTALL) -d $(PREFIX)/lib/pkgconfig
	$(INSTALL) -m 644 vmath.pc $(PREFIX)/lib/pkgconfig

.PHONY: uninstall
uninstall:
	rm -f $(PREFIX)/lib/$(lib_a)
	rm -f $(PREFIX)/lib/$(lib_so)
	rm -f $(PREFIX)/include/vmath/*
	rmdir $(PREFIX)/include/vmath
	rm -f $(PREFIX)/lib/pkgconfig/vmath.pc

-include $(depfiles)

%.d: %.c
	@$(CPP) $(CFLAGS) -MM -MT $(@:.d=.o) $< >$@


.PHONY: clean
clean:
	rm -f $(obj) $(depfiles)

.PHONY: distclean
distclean:
	rm -f $(obj) $(depfiles) $(lib_so) $(lib_a) Makefile vmath.pc

.PHONY: dist
dist: distclean
	cd ..; tar czvf vmath.tar.gz vmath && mv vmath.tar.gz vmath/
